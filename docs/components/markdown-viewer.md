# Markdown文档查看器组件

## 组件概述

Markdown文档查看器是一个专用的页面组件，用于在雅韵应用内直接查看和渲染Markdown格式的文档文件。该组件通过接收URL参数来加载指定的Markdown文件，并使用marked.js库将其转换为HTML进行展示，同时支持代码高亮、深色/浅色模式切换等功能。

## 设计目标

- 提供优雅的应用内文档阅读体验，避免用户需要跳转到外部应用
- 支持所有Markdown标准语法，包括标题、列表、代码块、表格等
- 提供舒适的阅读体验，包括适当的字体大小、行高和段落间距
- 支持深色/浅色模式切换，与应用其他部分保持风格一致
- 提供良好的错误处理和加载状态提示
- 确保文档加载的可靠性和稳定性，处理各种异常情况

## 组件结构

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- 头部元信息及外部资源引用 -->
</head>
<body>
  <div class="container">
    <div class="header">
      <!-- 返回按钮、文档标题和主题切换按钮 -->
    </div>
    <div id="content">
      <!-- Markdown渲染内容区域 -->
    </div>
  </div>
  <script>
    // JavaScript逻辑
  </script>
</body>
</html>
```

## 主要功能

### 1. Markdown渲染

使用marked.js库将Markdown文本转换为HTML，支持以下Markdown元素：
- 标题（h1-h6）
- 段落和换行
- 强调（粗体、斜体）
- 列表（有序、无序）
- 链接和图片
- 引用块
- 代码（行内代码和代码块）
- 水平线
- 表格

### 2. 代码高亮

使用Prism.js提供代码高亮功能，支持多种编程语言的语法高亮显示，使代码块更易读和美观。

### 3. 主题切换

支持深色和浅色两种主题模式：
- 默认根据系统偏好设置自动选择主题
- 提供主题切换按钮，允许用户手动切换
- 使用localStorage保存用户的主题偏好设置
- 主题切换时平滑过渡动画

### 4. 多重文档加载机制

实现多层级的文档加载策略，确保文档加载的可靠性：
- 主要使用fetch API加载文档
- 当fetch失败时，尝试使用XMLHttpRequest作为备选方案
- 当远程加载都失败时，提供内置的备选文档内容
- 根据文档标题和路径进行智能匹配，自动选择合适的备选内容
- 提供路径规范化处理，确保相对路径正确解析

### 5. URL参数支持

通过URL查询参数接收文档信息：
- `path`：Markdown文件的路径
- `title`：文档标题，用于显示在页面标题栏和内容区域顶部

示例：`markdown-viewer.html?path=docs/design.md&title=设计文档`

### 6. 错误处理和用户反馈

提供友好的错误处理机制：
- 当文档不存在或加载失败时显示详细的错误提示
- 当未指定文档路径时提示用户
- 加载过程中显示动画和文字提示
- 提供可能的解决方案建议，指导用户解决问题
- 控制台输出详细的调试日志，便于问题追踪

## 样式特性

### 主题变量

使用CSS变量定义主题颜色，便于主题切换：

```css
:root {
  --brand-color: #8B0000;
  --gold-color: #D4AF37;
  --text-color: #333333;
  --text-color-subtle: #757575;
  --bg-color: #F7F7F7;
  --component-bg: #FFFFFF;
  --border-color: #E5E5E5;
}

html.dark {
  --text-color: #FFFFFF;
  --text-color-subtle: #AAAAAA;
  --bg-color: #121212;
  --component-bg: #1E1E1E;
  --border-color: #333333;
}
```

### Markdown内容样式

为Markdown渲染内容应用了精心设计的样式：
- 适当的标题大小和权重层级
- 舒适的行高和段落间距
- 引用块左侧边框采用品牌色
- 代码块使用圆角边框和暗色背景
- 链接文本使用品牌色并添加悬停效果

### 错误和加载状态样式

- 加载状态：居中显示的旋转图标和提示文字
- 错误状态：醒目的错误图标和消息框，包含清晰的错误描述
- 问题解决建议：提供可能的解决方案列表，帮助用户排查问题

## 交互逻辑

### 文档加载流程

1. 页面加载时，从URL查询参数中获取文档路径和标题
2. 规范化路径，确保相对路径正确处理
3. 显示加载动画和状态提示
4. 先尝试使用fetch API请求Markdown文件内容
5. 如果fetch失败，尝试使用XMLHttpRequest
6. 如果远程加载都失败，尝试从内置的备选文档内容中匹配
7. 使用marked库将Markdown文本解析为HTML
8. 将渲染后的HTML注入到内容区域
9. 使用Prism.js应用代码高亮

### 主题切换逻辑

1. 页面加载时，首先检查localStorage中保存的主题设置
2. 如果没有保存的设置，则检查系统颜色偏好
3. 应用相应的主题类到HTML元素
4. 用户点击主题切换按钮时，切换主题并保存到localStorage

### 返回功能

提供返回按钮，使用`history.back()`实现返回上一页面的功能，保持导航流畅性。

## 使用示例

1. 在应用中创建指向文档查看器的链接：

```html
<a href="./markdown-viewer.html?path=./docs/design.md&title=设计文档">查看设计文档</a>
```

2. 当用户点击链接时，将打开文档查看器页面并加载指定的文档

## 性能优化

- 使用异步加载和渲染，避免阻塞主线程
- 按需加载Prism.js的语言支持
- 使用CSS过渡效果实现平滑的主题切换
- 使用适当的缓存策略，减少重复请求
- 添加请求超时处理，避免长时间等待无响应的请求
- 提供本地备选内容，在网络问题情况下仍能提供基本功能

## 故障处理和容错机制

- 实现多层次的文档加载策略，从网络到本地备选内容
- 提供详细的错误提示和可能的解决方案
- 使用try-catch结构捕获各个环节可能的异常
- 添加请求超时机制，避免长时间等待
- 根据文档标题和路径进行智能匹配，提供最接近的备选内容
- 通过控制台日志输出详细的调试信息，方便排查问题

## 兼容性考虑

- 使用标准的Fetch API和ES6+特性，支持现代浏览器
- 为深色模式提供完整的样式适配
- 使用响应式设计，适应不同屏幕尺寸
- 提供XMLHttpRequest作为fetch API的备选方案，提高兼容性

## 未来改进方向

- 添加文档目录功能，方便长文档导航
- 支持锚点定位和页内跳转
- 添加图片缩放和预览功能
- 支持更多Markdown扩展语法
- 实现搜索功能，方便查找文档内容
- 添加文档预加载和缓存机制，提高加载速度
- 支持离线模式和更多备选内容 