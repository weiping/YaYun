<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>雅韵-播放页面</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="../js/rotateVinyl.js?v=1.2" onerror="console.error('无法加载rotateVinyl.js')"></script>
  <!-- 添加浏览器兼容性检测脚本 -->
  <script src="../js/browser-compatibility.js" defer></script>
  <!-- 添加性能优化脚本 -->
  <script src="../js/performance-optimizer.js" defer></script>
  <!-- 添加键盘可访问性支持脚本 -->
  <script src="../js/keyboard-accessibility.js" defer></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&family=SF+Pro+Text:wght@400;500&family=New+York:wght@400;500&display=swap');
    
    /* 全局动画定义 */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(0.97); }
      100% { transform: scale(1); }
    }
    
    @keyframes flash {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }
    
    :root {
      --brand-color: #8B0000;
      --gold-color: #D4AF37;
      --inactive-color: #757575;
      --bg-light: #FFFFFF;
      --bg-dark: #121212;
      --text-primary-light: #212121;
      --text-secondary-light: #757575;
      --text-primary-dark: #FFFFFF;
      --text-secondary-dark: #BDBDBD;
    }
    
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-light);
      color: var(--text-primary-light);
      width: 100%;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    
    body.dark {
      background-color: var(--bg-dark);
      color: var(--text-primary-dark);
    }
    
    /* 页面容器 */
    .player-container {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    /* 背景毛玻璃效果 */
    .background-blur {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      filter: blur(30px);
      opacity: 0.3;
      z-index: -1;
    }
    
    /* 顶部导航 */
    .top-bar {
      display: flex;
      padding: 20px;
      z-index: 10;
    }
    
    .back-button {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      transition: all 0.2s;
    }
    
    .dark .back-button {
      background-color: rgba(0, 0, 0, 0.3);
      color: var(--text-primary-dark);
    }
    
    .back-button:active {
      transform: scale(0.95);
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    /* 唱片机区域 */
    .vinyl-player {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 10px 20px 20px;
      margin-top: 10px;
      position: relative;
    }
    
    /* 唱片区域 */
    .vinyl-record-container {
      position: relative;
      width: 300px;
      height: 300px;
      z-index: 2;
      margin-top: 30px;
    }
    
    .vinyl-record {
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle at center, rgba(0,0,0,0.7) 30%, rgba(40,40,40,0.7) 31%, rgba(40,40,40,0.7) 70%, rgba(0,0,0,0.7) 71%);
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transform-origin: center center;
      will-change: transform, animation;
      /* 默认状态下无动画 */
      transform: rotate(0deg);
      animation: none;
    }
    
    /* 播放状态下的动画设置 */
    @keyframes rotateDisk {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 确保动画属性具有最高优先级 */
    .vinyl-record.playing {
      animation-name: rotateDisk !important;
      animation-duration: 20s !important;
      animation-timing-function: linear !important;
      animation-iteration-count: infinite !important;
      animation-play-state: running !important;
      animation-delay: 0s !important;
    }
    
    /* 确保暂停状态正确应用 */
    .vinyl-record:not(.playing) {
      animation: none !important;
      transition: transform 0.5s ease-out;
    }
    
    @keyframes rotateDisk {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    
    .vinyl-grooves {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: repeating-radial-gradient(
        circle at center,
        rgba(0,0,0,0) 0px,
        rgba(0,0,0,0) 2px,
        rgba(150,150,150,0.1) 3px,
        rgba(0,0,0,0) 4px
      );
      z-index: 2;
    }
    
    .vinyl-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
      z-index: 3;
    }
    
    .vinyl-label img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .vinyl-reflection {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.1) 100%);
      z-index: 4;
      pointer-events: none;
    }
    
    /* 唱针 */
    .tonearm-container {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 140px;
      height: 180px;
      z-index: 5;
      transform-origin: 70% 15%;
      transform: rotate(-30deg);
      transition: transform 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      will-change: transform;
    }
    
    .tonearm-container.playing {
      transform: rotate(0deg) !important;
    }
    
    /* 强制唱针动画在iframe中也能正常工作 */
    #tonearm.playing {
      transform: rotate(0deg) !important;
    }
    
    .tonearm {
      position: relative;
      width: 10px;
      height: 150px;
      background: linear-gradient(to right, #777, #999, #777);
      border-radius: 5px;
      transform-origin: top center;
      margin-left: 60px;
    }
    
    .tonearm-head {
      position: absolute;
      bottom: -10px;
      left: -5px;
      width: 20px;
      height: 30px;
      background: linear-gradient(to right, #555, #888, #555);
      border-radius: 3px;
    }
    
    .tonearm-pivot {
      position: absolute;
      top: 0;
      left: 50px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: radial-gradient(circle at center, #AAA, #666);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    
    /* 唱片封面显示在唱片中央 */
    .album-cover {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      height: 90%;
      border-radius: 50%;
      overflow: hidden;
      z-index: 1;
    }
    
    .album-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      opacity: 0.7;
    }
    
    /* 歌曲信息 */
    .song-info {
      margin-top: 40px;
      width: 100%;
      text-align: center;
    }
    
    .song-title {
      font-family: 'New York', serif;
      font-style: italic;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    .song-artist {
      font-size: 16px;
      color: var(--text-secondary-light);
      margin-bottom: 20px;
    }
    
    .dark .song-artist {
      color: var(--text-secondary-dark);
    }
    
    /* 进度条 */
    .progress-container {
      width: 100%;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    /* 进度条增强 - 增加触摸区域 */
    .progress-bar {
      width: 100%;
      height: 4px;
      background-color: rgba(150, 150, 150, 0.3);
      border-radius: 2px;
      position: relative;
      margin-bottom: 10px;
      cursor: pointer;
      touch-action: none; /* 防止浏览器默认触摸行为 */
    }
    
    /* 增加触摸区域 */
    .progress-bar::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 0;
      right: 0;
      bottom: -10px;
      z-index: 1;
    }
    
    .progress-current {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background-color: var(--brand-color);
      border-radius: 2px;
      width: 30%;
    }
    
    .progress-handle {
      position: absolute;
      top: 50%;
      left: 30%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
      background-color: var(--brand-color);
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .time-info {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-secondary-light);
    }
    
    .dark .time-info {
      color: var(--text-secondary-dark);
    }
    
    /* 控制按钮 */
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
    }
    
    .control-button {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background-color: transparent;
      color: var(--text-primary-light);
      font-size: 18px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent; /* 移除移动端点击高亮 */
      touch-action: manipulation; /* 改善触摸体验 */
    }
    
    .dark .control-button {
      color: var(--text-primary-dark);
    }
    
    .control-button:active {
      transform: scale(0.95);
    }
    
    .control-button.pressed {
      transform: scale(0.92);
      animation: pulse 0.3s ease;
    }
    
    .control-button::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
      opacity: 0;
      transform: scale(0.5);
      transition: opacity 0.2s, transform 0.3s;
    }
    
    .control-button:active::after {
      opacity: 1;
      transform: scale(2);
    }
    
    .play-button {
      width: 64px;
      height: 64px;
      background-color: var(--brand-color);
      color: white;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
      z-index: 10;
    }
    
    .play-button:active, .play-button.active-effect {
      transform: scale(0.92);
      box-shadow: 0 2px 8px rgba(139, 0, 0, 0.5);
      background-color: #a50000;
    }
    
    .play-button::before {
      content: '';
      position: absolute;
      top: -10%;
      left: -10%;
      width: 120%;
      height: 120%;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%);
      opacity: 0;
      transform: scale(0.8);
      transition: opacity 0.3s, transform 0.3s;
      z-index: -1;
    }
    
    .play-button:active::before, .play-button.active-effect::before {
      opacity: 1;
      transform: scale(1.2);
    }
    
    .play-button::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
      opacity: 0;
      transform: scale(0.5);
      transition: opacity 0.3s, transform 0.3s;
      z-index: 1;
    }
    
    .play-button:active::after, .play-button.active-effect::after {
      opacity: 0.7;
      transform: scale(1.5);
    }
    
    /* 底部功能按钮 */
    .bottom-actions {
      display: flex;
      justify-content: space-around;
      padding: 5px 30px 20px;
      margin-top: 10px;
    }
    
    .action-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-secondary-light);
      font-size: 12px;
      padding: 8px 12px;
      min-width: 60px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .action-button:active {
      transform: scale(0.95);
      background-color: rgba(150, 150, 150, 0.1);
    }
    
    .dark .action-button {
      color: var(--text-secondary-dark);
    }
    
    .dark .action-button:active {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .action-icon {
      margin-bottom: 8px;
      font-size: 22px;
    }
    
    .action-button.active {
      color: var(--brand-color);
    }
    
    /* 音频可视化 */
    .audio-visualization {
      position: absolute;
      bottom: 190px;
      left: 0;
      width: 100%;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding: 0 40px;
      box-sizing: border-box;
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: 1;
    }
    
    .audio-visualization.visible {
      opacity: 1;
    }
    
    .visualizer-bar {
      width: 3px;
      height: 5px;
      margin: 0 2px;
      background-color: var(--brand-color);
      border-radius: 1px;
      transition: height 0.05s ease;
    }
    
    /* 音质选择增强 */
    .quality-selector {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0 0 20px;
      position: relative;
    }
    
    .quality-option {
      padding: 6px 12px;
      margin: 0 6px;
      border-radius: 14px;
      font-size: 12px;
      background-color: rgba(150, 150, 150, 0.1);
      color: var(--text-secondary-light);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .dark .quality-option {
      background-color: rgba(150, 150, 150, 0.2);
      color: var(--text-secondary-dark);
    }
    
    .quality-option.active {
      background-color: var(--brand-color);
      color: white;
      box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
    }
    
    .quality-option .ripple {
      position: absolute;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      transform: scale(0);
      animation: ripple 0.6s linear;
      pointer-events: none;
    }
    
    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }
    
    .quality-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      width: max-content;
      z-index: 10;
    }
    
    .quality-tooltip.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(-5px);
    }
    
    .quality-tooltip:after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
    }
    
    /* 粒子效果 - 增强版 */
    .particles-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }
    
    .particle {
      position: absolute;
      background-color: var(--brand-color);
      border-radius: 50%;
      opacity: 0.8;
      transform: scale(0);
      animation: particleAnimation 0.8s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
      box-shadow: 0 0 8px rgba(139, 0, 0, 0.5);
    }
    
    .particle.gold {
      background-color: var(--gold-color);
      box-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
    }
    
    .particle.white {
      background-color: #ffffff;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.7);
    }
    
    @keyframes particleAnimation {
      0% {
        transform: scale(0);
        opacity: 0.9;
      }
      50% {
        opacity: 0.7;
      }
      100% {
        transform: scale(1.5);
        opacity: 0;
      }
    }
    
    @keyframes floatUp {
      0% {
        transform: translateY(0) scale(0.8);
        opacity: 0.9;
      }
      100% {
        transform: translateY(-80px) scale(0.2);
        opacity: 0;
      }
    }
    
    /* 按钮样式 */
    .control-button, .action-button, .quality-option {
      -webkit-tap-highlight-color: transparent; /* 移除iOS触摸高亮 */
      touch-action: manipulation; /* 改善触摸体验 */
    }
    
    /* 触摸反馈相关 */
    .touch-ripple {
      position: absolute;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.3);
      transform: scale(0);
      pointer-events: none;
      z-index: 10;
    }
    
    /* 触摸滑动区域 */
    .swipe-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      touch-action: pan-x pan-y; /* 允许水平和垂直滑动 */
    }
  </style>
</head>
<body class="dark">
  <!-- 引入状态栏 -->
  <div id="status-bar-container">
    <!-- 内联状态栏 -->
    <div class="status-bar flex items-center justify-between px-5 dark" id="status-bar" style="height: 44px; width: 100%; position: fixed; top: 0; left: 0; z-index: 50; background-color: rgba(18, 18, 18, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white;">
      <!-- 左侧时间 -->
      <div class="time text-sm font-semibold" id="status-time">9:41</div>
      
      <!-- 中间灵动岛区域 -->
      <div class="dynamic-island w-28 h-8 rounded-full bg-black absolute left-1/2 transform -translate-x-1/2 top-0"></div>
      
      <!-- 右侧状态图标 -->
      <div class="status-icons flex items-center space-x-1.5">
        <!-- 信号强度 -->
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M1 20h22v2H1v-2zm0-2h22v-2H1v2zm0-4h22v-2H1v2zm0-4h22V8H1v2zm0-6v2h22V4H1z"/>
        </svg>
        
        <!-- WiFi -->
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 6C8.62 6 5.5 7.12 3 9L1.2 6.6C4.21 4.34 7.95 3 12 3s7.79 1.34 10.8 3.6L21 9c-2.5-1.88-5.62-3-9-3zm0 6c-1.94 0-3.75.5-5.33 1.33L4.8 11.4C6.87 10.23 9.33 9.5 12 9.5s5.13.73 7.2 1.9l-1.87 1.93C15.75 12.5 13.94 12 12 12zm0 6c-.89 0-1.74-.2-2.5-.55l-2.43-2.48c1.46-.64 3.08-1 4.93-1s3.47.36 4.93 1l-2.43 2.48c-.76.35-1.61.55-2.5.55z"/>
        </svg>
        
        <!-- 电池 -->
        <div class="battery flex items-center">
          <svg class="w-6 h-4" viewBox="0 0 25 12" fill="none" stroke="currentColor">
            <rect x="0.5" y="0.5" width="21" height="11" rx="2.5" stroke-width="1"/>
            <rect x="2" y="2" width="16" height="8" fill="currentColor"/>
            <rect x="23" y="4" width="2" height="4" fill="currentColor"/>
          </svg>
          <span class="text-xs ml-0.5">80%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 页面容器 -->
  <div class="player-container">
    <!-- 毛玻璃背景效果 -->
    <div class="background-blur" style="background-image: url(https://images.unsplash.com/photo-1507838153414-b4b713384a76?auto=format&fit=crop&w=1200&h=900&q=80);"></div>
    
    <!-- 顶部返回按钮 -->
    <div class="top-bar pt-12">
      <a href="javascript:history.back()" class="back-button w-10 h-10 flex items-center justify-center rounded-full bg-black bg-opacity-50">
        <i class="fas fa-chevron-left text-white"></i>
      </a>
    </div>
    
    <!-- 触摸滑动区域 -->
    <div class="swipe-area" id="swipeArea"></div>
    
    <!-- 唱片机区域 -->
    <div class="vinyl-player">
      <!-- 唱针 -->
      <div class="tonearm-container" id="tonearm">
        <div class="tonearm-pivot"></div>
        <div class="tonearm">
          <div class="tonearm-head"></div>
        </div>
      </div>
      
      <!-- 唱片区域 -->
      <div class="vinyl-record-container">
        <div class="vinyl-record" id="vinyl">
          <div class="vinyl-grooves"></div>
          <div class="vinyl-label">
            <img src="https://images.unsplash.com/photo-1514320291840-2e0a9bf2a9ae?auto=format&fit=crop&w=300&q=80" alt="专辑封面">
          </div>
          <div class="vinyl-reflection"></div>
        </div>
      </div>
      
      <!-- 音频可视化 -->
      <div class="audio-visualization visible" id="audioVisualization"></div>
      
      <!-- 歌曲信息 -->
      <div class="song-info">
        <div class="song-title">莫扎特：第三十五交响曲 "哈夫纳"</div>
        <div class="song-artist">维也纳爱乐乐团 · 伦纳德·伯恩斯坦</div>
      </div>
      
      <!-- 进度条 -->
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-current" id="progressCurrent"></div>
          <div class="progress-handle" id="progressHandle"></div>
        </div>
        <div class="time-info">
          <div class="time-current" id="currentTimeEl">2:45</div>
          <div class="time-total" id="totalTimeEl">8:23</div>
        </div>
      </div>
      
      <!-- 控制按钮 -->
      <div class="controls">
        <div class="control-button" id="prevButton">
          <i class="fas fa-backward-step"></i>
        </div>
        <div class="control-button">
          <i class="fas fa-backward"></i>
        </div>
        <div class="control-button play-button" id="playButton">
          <i class="fas fa-play" id="playIcon"></i>
        </div>
        <div class="control-button">
          <i class="fas fa-forward"></i>
        </div>
        <div class="control-button" id="nextButton">
          <i class="fas fa-forward-step"></i>
        </div>
      </div>
      
      <!-- 音质选择 -->
      <div class="quality-selector">
        <div class="quality-tooltip" id="qualityTooltip">选择音质会影响音乐细节和流量消耗</div>
        <div class="quality-option" data-quality="standard">标准音质</div>
        <div class="quality-option active" data-quality="high">高品质</div>
        <div class="quality-option" data-quality="lossless">无损</div>
      </div>
      
      <!-- 底部功能按钮 - 已移除"更多"按钮 -->
      <div class="bottom-actions">
        <div class="action-button" id="visualizeButton">
          <i class="action-icon fas fa-wave-square"></i>
          <span>可视化</span>
        </div>
        <div class="action-button">
          <i class="action-icon fas fa-share-nodes"></i>
          <span>分享</span>
        </div>
        <div class="action-button active">
          <i class="action-icon fas fa-heart"></i>
          <span>收藏</span>
        </div>
        <div class="action-button">
          <i class="action-icon fas fa-comment"></i>
          <span>评论</span>
        </div>
      </div>
    </div>
    
    <!-- 粒子效果容器 - 显示点击反馈 -->
    <div class="particles-container" id="particlesContainer"></div>
  </div>

  <script>
    // 全局变量
    const vinyl = document.getElementById('vinyl');
    const tonearm = document.getElementById('tonearm');
    const playButton = document.getElementById('playButton');
    const playIcon = document.getElementById('playIcon');
    const progressCurrent = document.getElementById('progressCurrent');
    const progressHandle = document.getElementById('progressHandle');
    const currentTimeEl = document.getElementById('currentTimeEl');
    const totalTimeEl = document.getElementById('totalTimeEl');
    const audioVisualization = document.getElementById('audioVisualization');
    const qualityTooltip = document.getElementById('qualityTooltip');
    const particlesContainer = document.getElementById('particlesContainer');
    const backButton = document.getElementById('backButton');
    
    let isPlaying = false;
    let progressInterval;
    let currentTime = 165; // 2:45
    const totalTime = 503; // 8:23
    let isVisualizationActive = true;
    const visualizerBars = [];
    
    // 直接在页面内定义旋转控制函数，确保一定可用
    function directRotateVinyl(shouldRotate) {
      const vinylElement = document.querySelector('.vinyl-record') || document.getElementById('vinyl');
      
      if (!vinylElement) {
        console.error("找不到唱片元素");
        return;
      }
      
      console.log("页面内直接控制唱片旋转:", shouldRotate);
      
      if (shouldRotate) {
        // 开始旋转
        vinylElement.classList.add('playing');
        vinylElement.style.setProperty('animation', 'rotateDisk 20s linear infinite', 'important');
        vinylElement.style.setProperty('animation-play-state', 'running', 'important');
        // 强制浏览器重新计算样式
        void vinylElement.offsetWidth;
      } else {
        // 停止旋转
        vinylElement.classList.remove('playing');
        vinylElement.style.setProperty('animation', 'none', 'important');
        vinylElement.style.setProperty('animation-play-state', 'paused', 'important');
        vinylElement.style.setProperty('transform', 'rotate(0deg)', 'important');
      }
      
      // 添加内联样式检查
      setTimeout(() => {
        console.log("唱片旋转状态检查:", {
          "类名": vinylElement.className,
          "内联动画": vinylElement.style.animation,
          "计算样式动画": window.getComputedStyle(vinylElement).animation,
          "动画状态": window.getComputedStyle(vinylElement).animationPlayState
        });
      }, 50);
    }
    
    // 初始化页面
    function initPlayer() {
      console.log("初始化播放器...");
      
      // 确保有正确的CSS动画定义
      addRotateDiskAnimationStyle();
      
      // 创建音频可视化条
      createVisualizerBars();
      
      // 初始化质量选项点击事件
      initQualityOptions();
      
      // 初始化进度条
      updateProgressDisplay();
      
      // 初始化进度条触摸控制
      initProgressTouch();
      
      // 初始化按钮事件
      initButtonEvents();
      
      // 初始化左右滑动切换
      initSwipeGestures();
      
      // 初始化页面触摸反馈
      initTouchFeedback();
      
      // 显示音质提示
      setTimeout(() => {
        showQualityTooltip('high');
      }, 1500);
      
      // 启动可视化效果
      updateVisualization();
      
      // 检查DOM元素引用
      console.log("DOM元素检查:", {
        vinyl: vinyl,
        tonearm: tonearm,
        playButton: playButton,
        playIcon: playIcon
      });
    }
    
    // 添加旋转动画CSS样式
    function addRotateDiskAnimationStyle() {
      if (!document.querySelector('style#vinyl-animations-inline')) {
        const styleEl = document.createElement('style');
        styleEl.id = 'vinyl-animations-inline';
        styleEl.innerHTML = `
          @keyframes rotateDisk {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .vinyl-record.playing {
            animation-name: rotateDisk !important;
            animation-duration: 20s !important;
            animation-timing-function: linear !important;
            animation-iteration-count: infinite !important;
            animation-play-state: running !important;
            animation-delay: 0s !important;
          }
        `;
        document.head.appendChild(styleEl);
        console.log("已添加内联旋转动画样式");
      }
    }
    
    // 创建音频可视化条
    function createVisualizerBars() {
      // 清空现有内容
      audioVisualization.innerHTML = '';
      
      // 创建32个频谱条
      for (let i = 0; i < 32; i++) {
        const bar = document.createElement('div');
        bar.className = 'visualizer-bar';
        audioVisualization.appendChild(bar);
        visualizerBars.push(bar);
      }
    }
    
    // 更新音频可视化
    function updateVisualization() {
      if (!isVisualizationActive) return;
      
      // 使用随机高度模拟音频频谱数据
      visualizerBars.forEach(bar => {
        // 如果正在播放，则条形高度会变化
        const height = isPlaying ? Math.random() * 40 + 5 : 5;
        bar.style.height = `${height}px`;
      });
      
      // 使用requestAnimationFrame实现平滑动画
      requestAnimationFrame(updateVisualization);
    }
    
    // 初始化质量选项点击事件
    function initQualityOptions() {
      const qualityOptions = document.querySelectorAll('.quality-option');
      
      qualityOptions.forEach(option => {
        option.addEventListener('click', function(event) {
          const quality = this.dataset.quality;
          
          // 移除所有选项的激活状态
          qualityOptions.forEach(opt => opt.classList.remove('active'));
          
          // 为当前选项添加激活状态
          this.classList.add('active');
          
          // 创建涟漪效果
          createRippleEffect(this, event);
          
          // 显示提示信息
          showQualityTooltip(quality);
          
          // 创建粒子效果
          createParticles(this);
        });
      });
    }
    
    // 创建涟漪效果
    function createRippleEffect(element, event) {
      const ripple = document.createElement('span');
      ripple.className = 'ripple';
      element.appendChild(ripple);
      
      const rect = element.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height);
      
      ripple.style.width = ripple.style.height = `${size}px`;
      ripple.style.left = `${event.clientX - rect.left - size / 2}px`;
      ripple.style.top = `${event.clientY - rect.top - size / 2}px`;
      
      setTimeout(() => {
        ripple.remove();
      }, 600);
    }
    
    // 显示音质提示
    function showQualityTooltip(quality) {
      let message = '';
      
      switch (quality) {
        case 'standard':
          message = '标准音质 (128kbps), 适合流量敏感场景';
          break;
        case 'high':
          message = '高品质 (320kbps), 平衡音质与流量';
          break;
        case 'lossless':
          message = '无损音质 (FLAC), 提供原始录音品质, 消耗更多流量';
          break;
      }
      
      qualityTooltip.textContent = message;
      qualityTooltip.classList.add('visible');
      
      setTimeout(() => {
        qualityTooltip.classList.remove('visible');
      }, 3000);
    }
    
    // 初始化按钮事件
    function initButtonEvents() {
      // 播放/暂停按钮 - 确保只绑定一次事件
      if (playButton) {
        // 清除所有现有事件
        const newPlayButton = playButton.cloneNode(true);
        playButton.parentNode.replaceChild(newPlayButton, playButton);
        
        // 重新获取引用并添加事件监听器
        const playBtn = document.getElementById('playButton');
        playBtn.addEventListener('click', function(event) {
          console.log("播放按钮被点击 (新事件处理程序)");
          event.preventDefault();
          event.stopPropagation();
          togglePlay();
        });
      }
      
      // 上一曲按钮
      const prevBtn = document.getElementById('prevButton');
      if (prevBtn) {
        const newPrevBtn = prevBtn.cloneNode(true);
        prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
        document.getElementById('prevButton').addEventListener('click', prevTrack);
      }
      
      // 下一曲按钮
      const nextBtn = document.getElementById('nextButton');
      if (nextBtn) {
        const newNextBtn = nextBtn.cloneNode(true);
        nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
        document.getElementById('nextButton').addEventListener('click', nextTrack);
      }
      
      // 可视化按钮
      const visualizeBtn = document.getElementById('visualizeButton');
      if (visualizeBtn) {
        const newVisualizeBtn = visualizeBtn.cloneNode(true);
        visualizeBtn.parentNode.replaceChild(newVisualizeBtn, visualizeBtn);
        document.getElementById('visualizeButton').addEventListener('click', function() {
          toggleVisualization();
          this.classList.toggle('active');
          createParticles(this);
        });
      }
      
      // 返回按钮
      if (backButton) {
        const newBackButton = backButton.cloneNode(true);
        backButton.parentNode.replaceChild(newBackButton, backButton);
        document.getElementById('backButton').addEventListener('click', function() {
          createParticles(this);
          console.log('返回上一页');
          history.back();
        });
      }
      
      // 为所有操作按钮添加粒子效果
      document.querySelectorAll('.action-button').forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        newButton.addEventListener('click', function() {
          createParticles(this);
        });
      });
    }
    
    // 切换可视化效果
    function toggleVisualization() {
      isVisualizationActive = !isVisualizationActive;
      
      if (isVisualizationActive) {
        audioVisualization.classList.add('visible');
        updateVisualization();
      } else {
        audioVisualization.classList.remove('visible');
      }
    }
    
    // 播放/暂停切换 - 进一步简化和强化
    function togglePlay() {
      console.log("★★★ togglePlay被调用 ★★★");
      
      try {
        // 切换播放状态
        isPlaying = !isPlaying;
        console.log("播放状态切换为:", isPlaying);
        
        // 播放按钮有明显视觉反馈
        const playBtn = document.getElementById('playButton');
        playBtn.classList.add('active-effect');
        setTimeout(() => {
          playBtn.classList.remove('active-effect');
        }, 300);
        
        // 在按钮周围创建更多粒子效果
        createEnhancedParticles(playBtn, isPlaying);
        
        // 处理两种状态
        if (isPlaying) {
          // === 播放状态 ===
          console.log("切换到播放状态 - 开始旋转唱片");
          
          // 1. 图标切换为暂停
          const playIconEl = document.getElementById('playIcon');
          playIconEl.className = 'fas fa-pause';
          
          // 2. 控制唱片旋转 - 多重保障
          console.log("开始旋转唱片 - 多重方法尝试");
          
          // 方法1: 使用页面内定义的函数（首选）
          directRotateVinyl(true);
          
          // 方法2: 尝试使用外部脚本函数（备用）
          try {
            if (typeof window.rotateVinyl === 'function') {
              window.rotateVinyl(true);
            }
          } catch (err) {
            console.warn("外部rotateVinyl调用失败:", err);
          }
          
          // 方法3: 直接操作DOM（终极保障）
          try {
            const vinylEl = document.getElementById('vinyl');
            if (vinylEl) {
              vinylEl.classList.add('playing');
              vinylEl.style.setProperty('animation', 'rotateDisk 20s linear infinite', 'important');
              vinylEl.style.setProperty('animation-play-state', 'running', 'important');
              // 强制重新计算样式
              void vinylEl.offsetWidth;
            }
          } catch (domErr) {
            console.error("直接DOM操作失败:", domErr);
          }
          
          // 添加唱片开始旋转的粒子效果
          setTimeout(() => {
            const vinylEl = document.getElementById('vinyl');
            if (vinylEl) {
              createCircleParticles(vinylEl, 'gold');
            }
          }, 100);
          
          // 3. 唱针放下
          const tonearmEl = document.getElementById('tonearm');
          if (tonearmEl) {
            tonearmEl.style.transform = 'rotate(0deg)';
            tonearmEl.classList.add('playing');
          }
          
          // 4. 开始进度更新
          startProgress();
          
          // 5. 启动可视化
          if (isVisualizationActive) {
            audioVisualization.classList.add('visible');
            updateVisualization();
          }
        } else {
          // === 暂停状态 ===
          console.log("切换到暂停状态 - 停止旋转唱片");
          
          // 1. 图标切换为播放
          const playIconEl = document.getElementById('playIcon');
          playIconEl.className = 'fas fa-play';
          
          // 2. 控制唱片旋转 - 多重保障
          console.log("停止旋转唱片 - 多重方法尝试");
          
          // 方法1: 使用页面内定义的函数（首选）
          directRotateVinyl(false);
          
          // 方法2: 尝试使用外部脚本函数（备用）
          try {
            if (typeof window.rotateVinyl === 'function') {
              window.rotateVinyl(false);
            }
          } catch (err) {
            console.warn("外部rotateVinyl调用失败:", err);
          }
          
          // 方法3: 直接操作DOM（终极保障）
          try {
            const vinylEl = document.getElementById('vinyl');
            if (vinylEl) {
              vinylEl.classList.remove('playing');
              vinylEl.style.setProperty('animation', 'none', 'important');
              vinylEl.style.setProperty('animation-play-state', 'paused', 'important');
              vinylEl.style.setProperty('transform', 'rotate(0deg)', 'important');
            }
          } catch (domErr) {
            console.error("直接DOM操作失败:", domErr);
          }
          
          // 添加唱片停止旋转的粒子效果
          setTimeout(() => {
            const vinylEl = document.getElementById('vinyl');
            if (vinylEl) {
              createCircleParticles(vinylEl, 'white');
            }
          }, 100);
          
          // 3. 唱针抬起
          const tonearmEl = document.getElementById('tonearm');
          if (tonearmEl) {
            tonearmEl.style.transform = 'rotate(-30deg)';
            tonearmEl.classList.remove('playing');
          }
          
          // 4. 停止进度更新
          stopProgress();
        }
        
        // 确保检查并报告唱片状态 - 延长等待时间确保样式已应用
        setTimeout(() => {
          const vinylEl = document.getElementById('vinyl');
          if (vinylEl) {
            const computedStyle = window.getComputedStyle(vinylEl);
            console.log("唱片样式最终检查:", {
              "类名": vinylEl.className,
              "内联样式": vinylEl.style.cssText,
              "animation": computedStyle.animation,
              "animationPlayState": computedStyle.animationPlayState,
              "transform": computedStyle.transform
            });
          }
        }, 100);
      } catch (error) {
        console.error("togglePlay执行出错:", error);
      }
    }
    
    // 创建增强的粒子效果
    function createEnhancedParticles(element, isStarting) {
      if (!element) return;
      
      try {
        const rect = element.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        // 创建15-25个粒子
        const particleCount = Math.floor(Math.random() * 10) + 15;
        
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.classList.add('particle');
          
          // 根据播放状态选择粒子颜色
          if (isStarting) {
            // 播放状态 - 主要是红色和金色粒子
            if (Math.random() > 0.7) {
              particle.classList.add('gold');
            }
          } else {
            // 暂停状态 - 主要是红色和白色粒子
            if (Math.random() > 0.7) {
              particle.classList.add('white');
            }
          }
          
          // 随机大小 (3-8px)
          const size = Math.random() * 5 + 3;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          
          // 随机位置 (围绕点击中心)
          const angle = Math.random() * Math.PI * 2;
          const distance = Math.random() * 50 + 10;
          const x = centerX + Math.cos(angle) * distance;
          const y = centerY + Math.sin(angle) * distance;
          
          particle.style.left = `${x}px`;
          particle.style.top = `${y}px`;
          
          // 添加到容器
          particlesContainer.appendChild(particle);
          
          // 动画结束后移除
          setTimeout(() => {
            particle.remove();
          }, 800);
        }
      } catch (error) {
        console.error("增强粒子效果创建失败:", error);
      }
    }
    
    // 创建环形粒子效果
    function createCircleParticles(element, type) {
      if (!element) return;
      
      try {
        const rect = element.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const radius = rect.width / 2;
        
        // 创建环形粒子
        const particleCount = 20;
        
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.classList.add('particle');
          
          // 设置粒子类型
          if (type === 'gold') {
            particle.classList.add('gold');
          } else if (type === 'white') {
            particle.classList.add('white');
          }
          
          // 粒子大小
          const size = Math.random() * 4 + 2;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          
          // 均匀分布在圆周上
          const angle = (i / particleCount) * Math.PI * 2;
          const x = centerX + Math.cos(angle) * radius;
          const y = centerY + Math.sin(angle) * radius;
          
          particle.style.left = `${x}px`;
          particle.style.top = `${y}px`;
          
          // 添加到容器
          particlesContainer.appendChild(particle);
          
          // 动画结束后移除
          setTimeout(() => {
            particle.remove();
          }, 800);
        }
      } catch (error) {
        console.error("环形粒子效果创建失败:", error);
      }
    }
    
    // 上一曲
    function prevTrack() {
      if (isPlaying) {
        stopProgress();
        isPlaying = false;
        playIcon.classList.remove('fa-pause');
        playIcon.classList.add('fa-play');
      }
      
      // 使用直接控制函数停止唱片旋转
      directRotateVinyl(false);
      tonearm.classList.remove('playing');
      
      setTimeout(() => {
        // 重置进度
        currentTime = 0;
        updateProgressDisplay();
      }, 800);
      
      // 创建粒子效果
      createEnhancedParticles(document.getElementById('prevButton'), false);
    }
    
    // 下一曲
    function nextTrack() {
      if (isPlaying) {
        stopProgress();
        isPlaying = false;
        playIcon.classList.remove('fa-pause');
        playIcon.classList.add('fa-play');
      }
      
      // 使用直接控制函数停止唱片旋转
      directRotateVinyl(false);
      tonearm.classList.remove('playing');
      
      setTimeout(() => {
        // 重置进度
        currentTime = 0;
        updateProgressDisplay();
      }, 800);
      
      // 创建粒子效果
      createEnhancedParticles(document.getElementById('nextButton'), false);
    }
    
    // 开始进度更新
    function startProgress() {
      clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        currentTime += 1;
        if (currentTime >= totalTime) {
          currentTime = 0;
          nextTrack();
        }
        updateProgressDisplay();
      }, 1000);
    }
    
    // 停止进度更新
    function stopProgress() {
      clearInterval(progressInterval);
    }
    
    // 更新进度显示
    function updateProgressDisplay() {
      const progress = (currentTime / totalTime) * 100;
      progressCurrent.style.width = `${progress}%`;
      progressHandle.style.left = `${progress}%`;
      
      // 更新时间显示
      currentTimeEl.textContent = formatTime(currentTime);
    }
    
    // 格式化时间
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // 生成粒子效果
    function createParticles(element) {
      if (!element) {
        console.error("createParticles: 元素不存在");
        return;
      }
      
      console.log("创建粒子效果, 元素:", element);
      try {
        const rect = element.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        // 创建10-15个粒子
        const particleCount = Math.floor(Math.random() * 6) + 10;
        
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.classList.add('particle');
          
          // 随机大小 (3-6px)
          const size = Math.random() * 3 + 3;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          
          // 随机位置 (围绕点击中心)
          const angle = Math.random() * Math.PI * 2;
          const distance = Math.random() * 40 + 10;
          const x = centerX + Math.cos(angle) * distance;
          const y = centerY + Math.sin(angle) * distance;
          
          particle.style.left = `${x}px`;
          particle.style.top = `${y}px`;
          
          // 添加到容器
          particlesContainer.appendChild(particle);
          
          // 动画结束后移除
          setTimeout(() => {
            particle.remove();
          }, 600);
        }
      } catch (error) {
        console.error("粒子效果创建失败:", error);
      }
    }
    
    // 初始化进度条触摸控制
    function initProgressTouch() {
      const progressBar = document.querySelector('.progress-bar');
      const handleEl = document.getElementById('progressHandle');
      const progressCurrentEl = document.getElementById('progressCurrent');
      
      if (!progressBar || !handleEl || !progressCurrentEl) {
        console.error("进度条元素不存在");
        return;
      }
      
      // 记录拖动状态
      let isDragging = false;
      // 记录播放状态，用于拖动时暂时暂停播放
      let wasPlaying = false;
      
      // 显示触摸反馈指示
      function showTouchFeedback(show) {
        if (show) {
          handleEl.style.transform = 'translate(-50%, -50%) scale(1.5)';
          handleEl.style.boxShadow = '0 0 10px rgba(139, 0, 0, 0.5)';
        } else {
          handleEl.style.transform = 'translate(-50%, -50%)';
          handleEl.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';
        }
      }
      
      // 计算触摸位置对应的进度
      function calculateProgress(e) {
        const rect = progressBar.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX) || (e.changedTouches && e.changedTouches[0].clientX);
        
        if (clientX === undefined) return null;
        
        let position = (clientX - rect.left) / rect.width;
        // 限制在0-1范围内
        position = Math.max(0, Math.min(1, position));
        return position;
      }
      
      // 更新UI显示
      function updateUI(progress) {
        if (progress === null) return;
        
        const progressPercent = progress * 100;
        progressCurrentEl.style.width = `${progressPercent}%`;
        handleEl.style.left = `${progressPercent}%`;
        
        // 更新当前时间
        currentTime = Math.floor(progress * totalTime);
        currentTimeEl.textContent = formatTime(currentTime);
        
        // 创建波纹效果
        createProgressRipple(progress);
      }
      
      // 创建进度条波纹效果
      function createProgressRipple(progress) {
        const rect = progressBar.getBoundingClientRect();
        const x = rect.left + (rect.width * progress);
        const y = rect.top + (rect.height / 2);
        
        const ripple = document.createElement('div');
        ripple.className = 'progress-ripple';
        ripple.style.cssText = `
          position: absolute;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background-color: rgba(139, 0, 0, 0.6);
          transform: scale(0);
          z-index: 100;
          pointer-events: none;
          animation: progressRipple 0.5s ease-out;
        `;
        
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        
        document.body.appendChild(ripple);
        
        // 添加一次性动画
        const keyframes = document.createElement('style');
        keyframes.textContent = `
          @keyframes progressRipple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
          }
        `;
        document.head.appendChild(keyframes);
        
        // 动画结束后移除元素
        setTimeout(() => {
          ripple.remove();
          keyframes.remove();
        }, 500);
      }
      
      // 触摸开始事件
      function handleTouchStart(e) {
        // 阻止默认行为和事件冒泡
        e.preventDefault();
        e.stopPropagation();
        
        // 记录当前播放状态
        wasPlaying = isPlaying;
        
        // 如果正在播放，暂时暂停以减少CPU负担
        if (isPlaying) {
          stopProgress();
          // 注意：此处不改变isPlaying状态或图标，只是暂停更新
        }
        
        isDragging = true;
        showTouchFeedback(true);
        
        // 立即更新位置
        const progress = calculateProgress(e);
        if (progress !== null) {
          updateUI(progress);
        }
        
        // 添加鼠标/触摸移动和结束事件
        document.addEventListener('mousemove', handleTouchMove);
        document.addEventListener('touchmove', handleTouchMove, { passive: false });
        document.addEventListener('mouseup', handleTouchEnd);
        document.addEventListener('touchend', handleTouchEnd);
      }
      
      // 触摸移动事件
      function handleTouchMove(e) {
        if (!isDragging) return;
        
        // 阻止默认行为和事件冒泡
        e.preventDefault();
        e.stopPropagation();
        
        // 更新位置
        const progress = calculateProgress(e);
        if (progress !== null) {
          updateUI(progress);
        }
      }
      
      // 触摸结束事件
      function handleTouchEnd(e) {
        if (!isDragging) return;
        
        // 最后更新一次位置
        const progress = calculateProgress(e);
        if (progress !== null) {
          updateUI(progress);
        }
        
        // 如果之前是播放状态，恢复播放
        if (wasPlaying) {
          startProgress();
        }
        
        isDragging = false;
        showTouchFeedback(false);
        
        // 移除事件监听
        document.removeEventListener('mousemove', handleTouchMove);
        document.removeEventListener('touchmove', handleTouchMove);
        document.removeEventListener('mouseup', handleTouchEnd);
        document.removeEventListener('touchend', handleTouchEnd);
        
        // 添加粒子效果
        createParticles(handleEl);
      }
      
      // 添加触摸/鼠标事件监听
      progressBar.addEventListener('mousedown', handleTouchStart);
      progressBar.addEventListener('touchstart', handleTouchStart, { passive: false });
      
      console.log("进度条触摸控制初始化完成");
    }
    
    // 初始化左右滑动切换手势
    function initSwipeGestures() {
      const vinylContainer = document.querySelector('.vinyl-record-container');
      const playerContainer = document.querySelector('.player-container');
      
      if (!vinylContainer || !playerContainer) {
        console.error("滑动手势初始化失败：容器元素不存在");
        return;
      }
      
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      let minSwipeDistance = 100; // 最小滑动距离，调整手势灵敏度
      
      // 滑动开始
      function handleSwipeStart(e) {
        touchStartX = e.touches ? e.touches[0].clientX : e.clientX;
        touchStartY = e.touches ? e.touches[0].clientY : e.clientY;
      }
      
      // 滑动结束
      function handleSwipeEnd(e) {
        touchEndX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
        touchEndY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
        
        // 计算水平和垂直滑动距离
        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;
        
        // 确保是水平滑动（水平距离大于垂直距离）
        if (Math.abs(deltaX) > Math.abs(deltaY)) {
          // 检查最小滑动距离
          if (Math.abs(deltaX) >= minSwipeDistance) {
            if (deltaX > 0) {
              // 向右滑动 - 上一曲
              console.log("唱片区域向右滑动 - 切换到上一曲");
              showSwipeFeedback('right');
              prevTrack();
            } else {
              // 向左滑动 - 下一曲
              console.log("唱片区域向左滑动 - 切换到下一曲");
              showSwipeFeedback('left');
              nextTrack();
            }
          }
        }
      }
      
      // 显示滑动反馈效果
      function showSwipeFeedback(direction) {
        // 创建滑动指示器
        const indicator = document.createElement('div');
        
        // 设置样式和内容
        indicator.style.cssText = `
          position: absolute;
          top: 50%;
          ${direction === 'left' ? 'right' : 'left'}: 10px;
          transform: translateY(-50%);
          background-color: rgba(0, 0, 0, 0.5);
          color: white;
          padding: 15px;
          border-radius: 50%;
          z-index: 100;
          opacity: 0;
          animation: swipeIndicator 0.8s ease-out;
        `;
        
        // 添加图标
        indicator.innerHTML = `<i class="fas fa-${direction === 'left' ? 'forward' : 'backward'}-step fa-2x"></i>`;
        
        // 添加到容器
        vinylContainer.appendChild(indicator);
        
        // 添加一次性动画
        const keyframes = document.createElement('style');
        keyframes.textContent = `
          @keyframes swipeIndicator {
            0% { opacity: 0; transform: translateY(-50%) scale(0.5); }
            50% { opacity: 0.9; transform: translateY(-50%) scale(1.2); }
            100% { opacity: 0; transform: translateY(-50%) scale(1.5); }
          }
        `;
        document.head.appendChild(keyframes);
        
        // 动画结束后移除元素
        setTimeout(() => {
          indicator.remove();
          keyframes.remove();
        }, 800);
      }
      
      // 添加事件监听
      vinylContainer.addEventListener('touchstart', handleSwipeStart, { passive: true });
      vinylContainer.addEventListener('touchend', handleSwipeEnd, { passive: true });
      
      console.log("唱片区域滑动手势初始化完成");
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      console.log("页面加载完成，初始化播放器...");
      
      // 首先运行兼容性测试并应用修复
      if (window.yaYunCompatibilityTest) {
        const testResults = window.yaYunCompatibilityTest.run();
        console.log('兼容性测试结果:', testResults);
        
        // 如果有严重问题，显示提示
        const highSeverityIssues = testResults.issues.filter(issue => issue.severity === 'high');
        if (highSeverityIssues.length > 0) {
          console.warn('检测到潜在的兼容性问题:', highSeverityIssues);
        }
      }
      
      // 立即添加旋转动画样式
      addRotateDiskAnimationStyle();
      
      // 初始化播放器
      initPlayer();
      
      // 更新状态栏时间
      updateStatusTime();
      
      // 每分钟更新一次状态栏时间
      setInterval(updateStatusTime, 60000);
      
      // 确保旋转函数在window上可用
      window.rotateVinyl = window.rotateVinyl || directRotateVinyl;
      
      // 对唱片添加直接点击测试
      const vinylEl = document.getElementById('vinyl');
      if (vinylEl) {
        // 移除现有事件
        const newVinylEl = vinylEl.cloneNode(true);
        vinylEl.parentNode.replaceChild(newVinylEl, vinylEl);
        
        // 添加新事件
        document.getElementById('vinyl').addEventListener('click', function() {
          console.log("唱片被点击，测试旋转");
          
          // 使用内部函数直接控制旋转
          if (this.classList.contains('playing')) {
            directRotateVinyl(false);
            isPlaying = false;
            document.getElementById('playIcon').className = 'fas fa-play';
          } else {
            directRotateVinyl(true);
            isPlaying = true;
            document.getElementById('playIcon').className = 'fas fa-pause';
          }
        });
      }
      
      // 设置初始主题
      setupTheme();
      
      // 测试唱片旋转
      setTimeout(() => {
        console.log("测试唱片旋转功能");
        const testVinyl = document.getElementById('vinyl');
        if (testVinyl) {
          console.log("旋转前状态:", window.getComputedStyle(testVinyl).animation);
          directRotateVinyl(true);
          setTimeout(() => {
            console.log("旋转后状态:", window.getComputedStyle(testVinyl).animation);
            directRotateVinyl(false);
          }, 1000);
        }
      }, 1500);
    });
    
    // 主题切换相关功能
    function setupTheme() {
      // 检查是否在iframe中
      const isInIframe = window.frameElement !== null;
      
      // 从localStorage读取主题设置
      const savedTheme = localStorage.getItem('yayun-theme');
      
      // 检查当前主题状态
      const currentIsDark = document.body.classList.contains('dark');
      console.log("当前主题状态:", currentIsDark ? "深色" : "浅色");
      
      // 监听系统主题变化
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      
      // 如果在iframe中，优先采用父窗口的主题设置
      if (isInIframe) {
        try {
          // 尝试从父窗口获取主题设置
          const parentIsDark = window.parent.document.documentElement.classList.contains('dark');
          console.log("检测到在iframe中，使用父窗口主题:", parentIsDark ? "深色" : "浅色");
          
          // 只有当当前主题与父窗口主题不一致时才切换
          if (parentIsDark !== currentIsDark) {
            toggleTheme(parentIsDark);
          }
        } catch (e) {
          console.warn("无法获取父窗口主题，使用本地设置:", e);
          // 如果有本地保存的主题设置，使用它
          if (savedTheme) {
            toggleTheme(savedTheme === 'dark');
          } else {
            // 否则使用系统偏好
            toggleTheme(prefersDarkScheme.matches);
          }
        }
      } else {
        // 独立运行模式
        console.log("独立页面模式");
        // 如果有本地保存的主题设置，使用它
        if (savedTheme) {
          toggleTheme(savedTheme === 'dark');
        } else {
          // 否则使用系统偏好
          toggleTheme(prefersDarkScheme.matches);
        }
        
        // 监听系统主题变化
        prefersDarkScheme.addEventListener('change', (e) => {
          if (!localStorage.getItem('yayun-theme')) {
            // 仅在用户未手动设置主题时响应系统变化
            toggleTheme(e.matches);
          }
        });
      }
      
      // 监听来自父窗口的主题变更消息
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'themeChange') {
          console.log("接收到主题变更消息:", event.data.isDark ? "深色" : "浅色");
          toggleTheme(event.data.isDark);
        }
      });
    }
    
    // 全局主题切换函数 - 加强版
    window.toggleTheme = function(isDark) {
      console.log("切换主题函数被调用，参数:", isDark);
      
      const body = document.body;
      const statusBar = document.getElementById('status-bar');
      
      try {
        // 函数以boolean参数调用时，设置指定主题
        if (typeof isDark === 'boolean') {
          console.log("设置主题为:", isDark ? "深色" : "浅色");
          
          // 设置body类
          if (isDark) {
            body.classList.add('dark');
          } else {
            body.classList.remove('dark');
          }
          
          // 更新状态栏
          if (statusBar) {
            if (isDark) {
              statusBar.classList.remove('light');
              statusBar.classList.add('dark');
              statusBar.style.backgroundColor = 'rgba(30, 30, 30, 0.8)';
            } else {
              statusBar.classList.remove('dark');
              statusBar.classList.add('light');
              statusBar.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
            }
          }
          
          // 保存设置
          localStorage.setItem('yayun-theme', isDark ? 'dark' : 'light');
          console.log("主题已设置为:", isDark ? "深色" : "浅色");
          
          return isDark;
        } 
        // 无参数调用时，切换当前主题
        else {
          const isDarkNow = body.classList.toggle('dark');
          console.log("主题已切换为:", isDarkNow ? "深色" : "浅色");
          
          // 更新状态栏
          if (statusBar) {
            if (isDarkNow) {
              statusBar.classList.remove('light');
              statusBar.classList.add('dark');
              statusBar.style.backgroundColor = 'rgba(30, 30, 30, 0.8)';
            } else {
              statusBar.classList.remove('dark');
              statusBar.classList.add('light');
              statusBar.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
            }
          }
          
          // 保存设置
          localStorage.setItem('yayun-theme', isDarkNow ? 'dark' : 'light');
          
          return isDarkNow;
        }
      } catch (error) {
        console.error("主题切换出错:", error);
        return body.classList.contains('dark');
      }
    };
    
    // 更新状态栏时间
    function updateStatusTime() {
      const now = new Date();
      let hours = now.getHours();
      let minutes = now.getMinutes();
      
      // 格式化时间
      hours = hours < 10 ? '0' + hours : hours;
      minutes = minutes < 10 ? '0' + minutes : minutes;
      
      document.getElementById('status-time').textContent = `${hours}:${minutes}`;
    }
    
    // 初始化页面触摸反馈
    function initTouchFeedback() {
      const container = document.querySelector('.player-container');
      const swipeArea = document.getElementById('swipeArea');
      const songInfo = document.querySelector('.song-info');
      const vinylPlayer = document.querySelector('.vinyl-player');
      
      if (!container || !swipeArea || !songInfo || !vinylPlayer) {
        console.error("触摸反馈初始化失败：元素不存在");
        return;
      }
      
      // 触摸反馈效果变量
      let startY = 0;
      let currentSection = 'player'; // 当前显示的部分: player, lyrics, info
      let isSwiping = false;
      let sections = ['player', 'lyrics', 'info'];
      let sectionIndex = 0;
      let touchStartTime = 0;
      
      // 创建歌词和信息面板
      const lyricsPanel = createLyricsPanel();
      const infoPanel = createInfoPanel();
      
      // 将面板添加到容器中
      vinylPlayer.appendChild(lyricsPanel);
      vinylPlayer.appendChild(infoPanel);
      
      // 创建三点指示器
      const pageIndicator = createPageIndicator();
      container.appendChild(pageIndicator);
      
      // 添加触摸开始事件
      swipeArea.addEventListener('touchstart', function(e) {
        // 记录开始位置和时间
        startY = e.touches[0].clientY;
        touchStartTime = new Date().getTime();
        isSwiping = true;
        
        // 创建触摸涟漪效果
        createTouchRipple(e);
      }, { passive: true });
      
      // 添加触摸移动事件
      swipeArea.addEventListener('touchmove', function(e) {
        if (!isSwiping) return;
        
        // 计算移动距离
        const deltaY = e.touches[0].clientY - startY;
        
        // 显示实时预览移动反馈
        if (Math.abs(deltaY) > 20) {
          const direction = deltaY > 0 ? 'down' : 'up';
          showSwipePreview(direction);
        }
      }, { passive: true });
      
      // 添加触摸结束事件
      swipeArea.addEventListener('touchend', function(e) {
        if (!isSwiping) return;
        
        const endY = e.changedTouches[0].clientY;
        const deltaY = endY - startY;
        const touchDuration = new Date().getTime() - touchStartTime;
        
        // 确保是垂直滑动并且滑动距离足够长
        if (Math.abs(deltaY) > 100 || (Math.abs(deltaY) > 50 && touchDuration < 300)) {
          if (deltaY < 0) {
            // 向上滑动，显示下一个部分
            sectionIndex = (sectionIndex + 1) % sections.length;
          } else {
            // 向下滑动，显示上一个部分
            sectionIndex = (sectionIndex - 1 + sections.length) % sections.length;
          }
          
          // 更新显示
          showSection(sections[sectionIndex]);
          
          // 更新指示器
          updatePageIndicator(sectionIndex);
        }
        
        isSwiping = false;
      }, { passive: true });
      
      // 创建触摸涟漪效果
      function createTouchRipple(e) {
        const ripple = document.createElement('div');
        ripple.className = 'touch-ripple';
        
        // 设置涟漪位置
        const x = e.touches[0].clientX;
        const y = e.touches[0].clientY;
        
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        ripple.style.animation = 'touchRipple 0.6s linear';
        
        // 添加到容器
        container.appendChild(ripple);
        
        // 添加一次性动画
        const keyframes = document.createElement('style');
        keyframes.textContent = `
          @keyframes touchRipple {
            0% { transform: scale(0); opacity: 0.5; }
            100% { transform: scale(3); opacity: 0; }
          }
        `;
        document.head.appendChild(keyframes);
        
        // 动画结束后移除元素
        setTimeout(() => {
          ripple.remove();
          keyframes.remove();
        }, 600);
      }
      
      // 显示滑动预览效果
      function showSwipePreview(direction) {
        // 获取对应部分
        let targetIndex = sectionIndex;
        
        if (direction === 'up') {
          targetIndex = (sectionIndex + 1) % sections.length;
        } else {
          targetIndex = (sectionIndex - 1 + sections.length) % sections.length;
        }
        
        // 创建预览提示
        const preview = document.createElement('div');
        preview.className = 'swipe-preview';
        preview.style.cssText = `
          position: absolute;
          ${direction === 'up' ? 'bottom' : 'top'}: 20px;
          left: 50%;
          transform: translateX(-50%);
          background-color: rgba(0, 0, 0, 0.7);
          color: white;
          padding: 10px 15px;
          border-radius: 20px;
          z-index: 200;
          font-size: 14px;
          opacity: 0;
          animation: previewShow 0.3s forwards;
          pointer-events: none;
        `;
        
        // 设置预览内容
        preview.textContent = direction === 'up' ? 
          (targetIndex === 1 ? '查看歌词' : '查看详情') : 
          (targetIndex === 0 ? '返回播放器' : '查看歌词');
        
        // 添加图标
        const icon = document.createElement('i');
        icon.className = `fas fa-chevron-${direction === 'up' ? 'up' : 'down'} mr-2`;
        preview.prepend(icon);
        
        // 添加到容器
        container.appendChild(preview);
        
        // 添加一次性动画
        const keyframes = document.createElement('style');
        keyframes.textContent = `
          @keyframes previewShow {
            0% { opacity: 0; transform: translateX(-50%) translateY(${direction === 'up' ? '10px' : '-10px'}); }
            100% { opacity: 1; transform: translateX(-50%) translateY(0); }
          }
        `;
        document.head.appendChild(keyframes);
        
        // 短暂显示后移除
        setTimeout(() => {
          preview.style.animation = 'previewHide 0.3s forwards';
          
          const hideKeyframes = document.createElement('style');
          hideKeyframes.textContent = `
            @keyframes previewHide {
              0% { opacity: 1; transform: translateX(-50%) translateY(0); }
              100% { opacity: 0; transform: translateX(-50%) translateY(${direction === 'up' ? '-10px' : '10px'}); }
            }
          `;
          document.head.appendChild(hideKeyframes);
          
          setTimeout(() => {
            preview.remove();
            keyframes.remove();
            hideKeyframes.remove();
          }, 300);
        }, 800);
      }
      
      // 创建歌词面板
      function createLyricsPanel() {
        const panel = document.createElement('div');
        panel.className = 'lyrics-panel';
        panel.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
          z-index: 50;
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        `;
        
        // 添加歌词内容
        panel.innerHTML = `
          <h2 class="text-2xl font-bold mb-6">莫扎特：第三十五交响曲 "哈夫纳"</h2>
          <div class="lyrics-content overflow-y-auto w-full max-h-[60vh] px-4 py-2">
            <p class="mb-4 opacity-70">K. 385: 1. Allegro con spirito</p>
            <p class="mb-4 font-bold">正在播放...</p>
            <p class="mb-4 opacity-70">K. 385: 2. Andante</p>
            <p class="mb-4 opacity-70">K. 385: 3. Menuetto</p>
            <p class="mb-4 opacity-70">K. 385: 4. Finale. Presto</p>
            <p class="mt-8 text-sm opacity-50">这是一部管弦乐作品，没有歌词</p>
          </div>
        `;
        
        return panel;
      }
      
      // 创建信息面板
      function createInfoPanel() {
        const panel = document.createElement('div');
        panel.className = 'info-panel';
        panel.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          display: flex;
          flex-direction: column;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
          z-index: 50;
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        `;
        
        // 添加信息内容
        panel.innerHTML = `
          <h2 class="text-2xl font-bold mb-4">作品信息</h2>
          <div class="info-content overflow-y-auto w-full pr-2">
            <div class="mb-4">
              <h3 class="text-lg font-semibold">作曲家</h3>
              <p>沃尔夫冈·阿玛多伊斯·莫扎特 (1756-1791)</p>
            </div>
            <div class="mb-4">
              <h3 class="text-lg font-semibold">指挥</h3>
              <p>伦纳德·伯恩斯坦</p>
            </div>
            <div class="mb-4">
              <h3 class="text-lg font-semibold">乐团</h3>
              <p>维也纳爱乐乐团</p>
            </div>
            <div class="mb-4">
              <h3 class="text-lg font-semibold">创作年代</h3>
              <p>1782-1783年</p>
            </div>
            <div class="mb-4">
              <h3 class="text-lg font-semibold">编号</h3>
              <p>K. 385</p>
            </div>
            <div class="mb-6">
              <h3 class="text-lg font-semibold">录制年份</h3>
              <p>1964年</p>
            </div>
            <div class="mb-4">
              <h3 class="text-lg font-semibold">作品简介</h3>
              <p class="text-sm leading-relaxed">
                莫扎特的《哈夫纳交响曲》是为庆祝莫扎特家族的朋友西格蒙德·哈夫纳晋升为萨尔茨堡市长而作。这部交响曲充满欢庆气氛，乐观而热闹，是莫扎特交响曲作品中的代表作。全曲由四个乐章组成，第一乐章充满活力，第二乐章优美抒情，第三乐章是典型的小步舞曲，第四乐章则速度飞快，技巧性强，展现了莫扎特出色的作曲才华。
              </p>
            </div>
          </div>
        `;
        
        return panel;
      }
      
      // 创建页面指示器
      function createPageIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'page-indicator';
        indicator.style.cssText = `
          position: absolute;
          bottom: 15px;
          left: 50%;
          transform: translateX(-50%);
          display: flex;
          gap: 8px;
          z-index: 100;
        `;
        
        // 添加三个点
        for (let i = 0; i < 3; i++) {
          const dot = document.createElement('div');
          dot.style.cssText = `
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: ${i === 0 ? '#8B0000' : 'rgba(255, 255, 255, 0.4)'};
            transition: background-color 0.3s ease, transform 0.3s ease;
          `;
          if (i === 0) {
            dot.style.transform = 'scale(1.5)';
          }
          indicator.appendChild(dot);
        }
        
        return indicator;
      }
      
      // 更新页面指示器
      function updatePageIndicator(activeIndex) {
        const dots = document.querySelectorAll('.page-indicator div');
        if (!dots.length) return;
        
        dots.forEach((dot, index) => {
          if (index === activeIndex) {
            dot.style.backgroundColor = '#8B0000';
            dot.style.transform = 'scale(1.5)';
          } else {
            dot.style.backgroundColor = 'rgba(255, 255, 255, 0.4)';
            dot.style.transform = 'scale(1)';
          }
        });
      }
      
      // 显示指定部分
      function showSection(section) {
        const lyricsPanel = document.querySelector('.lyrics-panel');
        const infoPanel = document.querySelector('.info-panel');
        const mainPlayer = document.querySelector('.vinyl-record-container');
        const songInfoSection = document.querySelector('.song-info');
        const controlsSection = document.querySelector('.controls');
        const qualitySection = document.querySelector('.quality-selector');
        const bottomSection = document.querySelector('.bottom-actions');
        
        // 根据部分名显示对应内容
        switch(section) {
          case 'player':
            // 显示播放器，隐藏其他
            lyricsPanel.style.opacity = '0';
            lyricsPanel.style.pointerEvents = 'none';
            infoPanel.style.opacity = '0';
            infoPanel.style.pointerEvents = 'none';
            
            mainPlayer.style.opacity = '1';
            songInfoSection.style.opacity = '1';
            controlsSection.style.opacity = '1';
            qualitySection.style.opacity = '1';
            bottomSection.style.opacity = '1';
            
            currentSection = 'player';
            break;
            
          case 'lyrics':
            // 显示歌词，隐藏其他
            lyricsPanel.style.opacity = '1';
            lyricsPanel.style.pointerEvents = 'auto';
            infoPanel.style.opacity = '0';
            infoPanel.style.pointerEvents = 'none';
            
            mainPlayer.style.opacity = '0.2';
            songInfoSection.style.opacity = '0.2';
            controlsSection.style.opacity = '0.2';
            qualitySection.style.opacity = '0';
            bottomSection.style.opacity = '0';
            
            currentSection = 'lyrics';
            break;
            
          case 'info':
            // 显示信息，隐藏其他
            lyricsPanel.style.opacity = '0';
            lyricsPanel.style.pointerEvents = 'none';
            infoPanel.style.opacity = '1';
            infoPanel.style.pointerEvents = 'auto';
            
            mainPlayer.style.opacity = '0.2';
            songInfoSection.style.opacity = '0.2';
            controlsSection.style.opacity = '0.2';
            qualitySection.style.opacity = '0';
            bottomSection.style.opacity = '0';
            
            currentSection = 'info';
            break;
        }
      }
      
      console.log("页面触摸反馈初始化完成");
    }
  </script>
</body>
</html>
